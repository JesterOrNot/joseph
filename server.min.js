"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}var server,port,shrinkRay=require("@magento/shrink-ray"),debug=require("debug")("okikio:server"),cookieParser=require("cookie-parser"),mcache=require("memory-cache"),express=require("express"),logger=require("morgan"),helmet=require("helmet"),http=require("http"),path=require("path"),app=express(),_require=require("./config.min"),routes=_require.routes,_require2=require("./engine.min"),engine=_require2.engine,day=864e5.toString(),week=6048e5.toString(),cache=function(i){return function(e,r,t){var n=e.header("x-barba"),a="__express__".concat(n?"__barba__":"").concat(e.originalUrl||e.url),o=mcache.get(a);o?r.send(o):(r.sendResponse=r.send,r.send=function(e){mcache.put(a,e,1e3*i),r.sendResponse(e)},t())}},render=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"index",n=1<arguments.length?arguments[1]:void 0;return function(e,r){r.render(t,{barba:e.header("x-barba"),data:n})}},get=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"/",r=1<arguments.length?arguments[1]:void 0,t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:day;app.get(e,cache(t),render(r))},normalizePort=function(e){var r=parseInt(e,10);return isNaN(r)?e:0<=r&&r};for(var i in port=normalizePort(process.env.PORT||"3000"),app.use(helmet()),app.use(shrinkRay()),app.use(express.static(path.join(__dirname,"public"),{maxAge:week})),app.use(express.static(path.join(__dirname,"config.js"),{maxAge:day})),app.use(function(e,r,t){"/favicon.ico"==e.originalUrl?r.status(204).json({nope:!0}):t()}),app.engine("html",engine),app.set("views",path.join(__dirname,"./public")),app.set("view engine","html"),app.set("view cache",!0),app.use(logger("dev")),app.use(express.json()),app.use(express.urlencoded({extended:!1})),app.use(cookieParser()),routes)get(i,routes[i]);app.use.apply(app,_toConsumableArray(function(e){(0,e[e.length-1])(createError(Number(404)))})),app.use(function(e,r,t){t.status(e.status||500),t.send("There was an error: "+(e.status||500))}),app.set("port",port),(server=http.createServer(app)).listen(port),server.on("error",function(e){if("listen"!==e.syscall)throw e;var r="string"==typeof port?"Pipe "+port:"Port "+port;switch(e.code){case"EACCES":console.error(r+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(r+" is already in use"),process.exit(1);break;default:throw e}}),server.on("listening",function(){var e=server.address(),r="string"==typeof e?"pipe "+e:"port "+e.port;debug("Listening on "+r)});